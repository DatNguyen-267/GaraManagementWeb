
<link rel="stylesheet" href="/css/employeeList.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<title>Danh sách nhân viên</title>
    <div class = "grid__content">
      <div class="header__breadcrumb">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="#">Danh sách nhân viên</a></li>
              </ol>
          </nav>
        </div>
      <header class = "employeeList__header">

        <div class="toolbar">
          <div class="toolbar__search">
            <input class="toolbar__search-input" style="padding:.4rem" type="search " id = "searchKey" placeholder="Tìm kiếm thông tin nhân viên" aria-label="Search" onkeyup="search()">
            <span class="ti-search toolbar__search-icon"> </span>
          </div>
          <div class="toolbar__btn">
            <button class="header__btn-add btn btn-primary" id = "btn--add-item">Thêm nhân viên mới</button>
          </div>
        </div>
    </header>
    <body class = "employeeList__body">
        <div class = "table-responsive">
            <table class="table table--default employeeList__body__table" id = "employeeTable" >
                <thead class="thead-dark">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Họ và Tên</th>
                    <th scope="col">Địa chỉ</th>
                    <th scope="col">Số điện thoại</th>
                    <th scope="col">Email</th>
                    <th scope="col">CMND</th>
                    <th scope="col">Chức vụ</th>
                    <th scope="col">Ngày bắt đầu làm</th>
                    <th scope="col"></th> 
                  </tr>
                </thead>
                <tbody>
                  
                  {{#each employee}}
                    <tr employeeID = "{{this._id}}"   n >
                    <th scope="row">{{sum @index 1}}</th>
                    <td id = "name">{{this.name}}</td>
                    <td id = "address">{{this.address}}</td>
                    <td id = "phoneNumber">{{this.phoneNumber}}</td>
                    <td id = "email">{{this.email}}</td>
                    <td id = "CMND">{{this.CMND}}</td>  
                    <td id = "tag">{{this.Tag}}</td>
                    <td id = "startDate">{{this.startDate}}</td>
                    <td>
                      <button class = "btn--edit-item" onclick="">Sửa</i></button>
                      <button class = "btn--delete-item" onclick="deleted()">Xóa</i></button>
                    </td>           
                  </tr>
                  {{/each}}
                </tbody>
              </table> 
        </div>
          
          <!--Modified Modal -->
          <form method="POST" name = "form-edit" action = "" id = "form-edit-employeeList">
            <div class="modal fade " id="modifiedModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered infoModal" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Chỉnh sửa</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form>
                    <div class="form-group">
                      <label for="reception-add-lincense" class="col-form-label">Tên nhân viên:</label>
                      <input type="text" class="form-control" name="name"  id = "m_name">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-phone" class="col-form-label">Địa chỉ:</label>
                      <input type="text" class="form-control" name="address"  id = "m_address">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-brand" class="col-form-label">Số điện thoại</label>
                      <input type="text" class="form-control" name="phoneNumber"  id = "m_phoneNumber">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Email:</label>
                      <input type="text" class="form-control" name="email"  id = "m_email">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">CMND:</label>
                      <input type="text" class="form-control" name="CMND"  id = "m_cmnd">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Chức vụ:</label>
                      <select class = "form-control" name="Tag" placeholder="" id = "m_tag">
                            <option value= "" disabled selected>Chọn loại nhân viên</option>
                            {{#each tag}}
                            <option value="{{this.name}}" salary = "{{this.salary}}" percent ="{{this.percent}}" tagID = {{this._id}} class= "mOps">{{this.name}}</option>
                            {{/each}}
                      </select>
                      <input type="hidden" id = "m_tagID" name = "position">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-lincense" class="col-form-label">Ngày bắt đầu làm:</label>
                      <input type="date" class="form-control dataStr" name="startDate" id = "m_startDate">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Lương:</label>
                      <input type="text" class="form-control" name="salary" readonly id = "m_salary">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Hệ số tăng lương:</label>
                      <input type="text" class="form-control" name="percent" readonly id = "m_percent" placeholder="%/năm">
                      <span class="form-message"></span>
                    </div>
                    
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                  <button type="submit" class="btn btn-primary" id = "btn-accept-edit">Lưu</button>
                </div>
              </div>
            </div>
          </div>
          </form>
          <!--Add Modal -->
          <form method="POST" action="create" id = "form-add-employeeList" name = "form-add">
            <div class="modal fade " id="addModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered infoModal" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Thêm nhân viên</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body" id =  "test">
                  <form>
                    <div class="form-group">
                      <label for="reception-add-lincense" class="col-form-label">Tên nhân viên:</label>
                      <input type="text" class="form-control" name="name" id = 'n_name'>
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-phone" class="col-form-label">Địa chỉ:</label>
                      <input type="text" class="form-control" name="address" id = 'n_address'>
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-brand" class="col-form-label">Số điện thoại</label>
                      <input type="text" class="form-control" name="phoneNumber" id = 'n_phoneNumber'>
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Email:</label>
                      <input type="text" class="form-control" name="email" id = 'n_email'>
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">CMND:</label>
                      <input type="text" class="form-control" name="CMND" id = 'n_cmnd'>
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Chức vụ:</label>
                      <select class = "form-control" name="Tag" placeholder="" id = "n_tag">
                            <option value= "" disabled selected>--- Chọn loại nhân viên ---</option>
                            {{#each tag}}
                              <option value="{{this.name}}" salary = "{{this.salary}}" percent="{{this.percent}}" tagID = {{this._id}} class= "nOps">{{this.name}}</option>
                            {{/each}}
                      </select>
                      <input type="hidden" id = "n_tagID" name = "position">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-lincense" class="col-form-label">Ngày bắt đầu làm:</label>
                      <input type="date" class="form-control dataStr" name="startDate" id = "n_startDate">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Lương:</label>
                      <input type="text" class="form-control" name="salary" style="" readonly id = "n_salary">
                      <span class="form-message"></span>
                    </div>
                    <div class="form-group">
                      <label for="reception-add-receptionDate" class="col-form-label">Hệ số tăng lương:</label>
                      <input type="text" class="form-control" name="percent" readonly id = "n_percent" placeholder="%/năm">
                      <span class="form-message"></span> 
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                  <button type="submit" class="btn btn-primary" id= "btn-add">Thêm</button>
                </div>
              </div>
            </div>
          </div>
          </form>
          <!--Delete Modal -->
          <form name="form-delete" method="POST" action="">
              <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Xóa nhân viên</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <label id = "informLabel">Bạn có chắc chắn muốn xóa nhân viên không?</label>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="btn-delete">Xóa</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
         

          
    </body>
    </div>


    <script>
      var formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
          });
      var employeeID;
      function search(){
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchKey");
        filter = input.value;
        table = document.getElementById("employeeTable");
        tr = $("tbody tr");
        for (i = 0; i < tr.length; i++) {
          var td1 = tr[i].getElementsByTagName("td")[0];
          if (td1) {
            txtValue = td1.textContent || td1.innerText;
            filter = filter.toUpperCase();
            txtValue = txtValue.toUpperCase();
            if (txtValue.includes(filter)) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }   
        }
      }
      Date.prototype.toDateInputValue = (function() {
          var local = new Date(this);
          local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
          return local.toJSON().slice(0,10);
      });
      $(".btn--edit-item").click(function() {
          employeeID = $(this).closest("tr").attr('employeeID');
          $('#m_name').val($(this).closest("tr").find("#name").text());
          $('#m_address').val($(this).closest("tr").find("#address").text());
          $('#m_phoneNumber').val($(this).closest("tr").find("#phoneNumber").text());
          $('#m_email').val($(this).closest("tr").find("#email").text());
          $('#m_cmnd').val($(this).closest("tr").find("#CMND").text());
          $('#m_tag').val($(this).closest("tr").find("#tag").text());
          $('#m_percent').val($('option:selected').attr('percent'));
          $('#m_startDate').val($(this).closest("tr").find("#startDate").text());
          $('#m_salary').val($('.mOps:selected').attr('salary'));
          $('#m_tagID').val($('.mOps:selected').attr('tagID'));
          $("#modifiedModal").modal();
      });
      
      $("#btn--add-item").click(function() {
          $('#n_startDate').val(new Date().toDateInputValue());
          $("#addModal").modal();
      });
      
      $('#m_tag').change(function(){
          $('#m_percent').val($('.mOps:selected').attr('percent'));
          $('#m_salary').val(formatter.format(salaryCal($('.mOps:selected').attr('percent'),$('.mOps:selected').attr('salary') )));
      });
       $('#n_tag').change(function(){
          $('#n_percent').val($('.nOps:selected').attr('percent'));
          $('#n_salary').val(formatter.format(salaryCal($('.nOps:selected').attr('percent'),$('.nOps:selected').attr('salary') )));
      });
      $('#n_startDate').change(function(){
          if ($('#n_tag').val() == "") return;
          $('#n_percent').val($('.nOps:selected').attr('percent'));
          $('#n_salary').val(formatter.format(salaryCal($('.nOps:selected').attr('percent'),$('.nOps:selected').attr('salary') )));
      });

      $('#m_startDate').change(function(){
          if ($('#m_tag').val() == "") return;
          $('#m_percent').val($('option:selected').attr('percent'));
          $('#m_salary').val(formatter.format(salaryCal($('.mOps:selected').attr('percent'),$('.mOps:selected').attr('salary') )));
      });

      $(".btn--delete-item").click(function() {
          var temp  = "Bạn có chắc chắn muốn xóa nhân viên " +  $(this).closest("tr").find("#name").text() + " ?";
          $("#informLabel").text(temp);
          employeeID = $(this).closest("tr").attr('employeeID');
          $("#deleteModal").modal();
      });
      $('#employeeTable tbody tr').click(function () {
        employeeID = $(this).attr('employeeID')
      });
      document.addEventListener('DOMContentLoaded', function () {
      //add validator
      Validator({
      form: '#form-add-employeeList', // id của cái form cần validate
      errorSelector: '.form-message', // tên class để hiện cái lỗi
      rules: [
        Validator.isRequireSelectBox('#n_tag','--- Chọn loại nhân viên ---', 'Vui chọn khách hàng'),
        Validator.isRequire('#n_name', 'Vui nhập tên nhân viên'),
        Validator.isRequire('#n_address', 'Vui nhập địa chỉ'),
        Validator.isRequire('#n_email', 'Vui nhập email'),
        Validator.isRequire('#n_phoneNumber', 'Vui lòng nhập số điện thoại'),
        Validator.isEmail('#n_email'),
        Validator.isRequire('#n_cmnd', 'Vui lòng nhập chứng minh nhân dân'),
        Validator.isNumber('#n_cmnd'),
        Validator.isNumber('#n_phoneNumber'),
      ],
      onSubmit: function() {
            
          formAddEmployee.action = 'employeeList/create'
          $('#n_tagID').val($('.nOps:selected').attr('tagID'));
          formAddEmployee.submit()  
        }
      })
      //modified validator  
      Validator({
      form: '#form-edit-employeeList', // id của cái form cần validate
      errorSelector: '.form-message', // tên class để hiện cái lỗi
      rules: [
        Validator.isRequireSelectBox('#m_tag','--- Chọn loại nhân viên ---', 'Vui chọn khách hàng'),
        Validator.isRequire('#m_name', 'Vui nhập tên nhân viên'),
        Validator.isRequire('#m_address', 'Vui nhập địa chỉ'),
        Validator.isRequire('#m_email', 'Vui nhập email'),
        Validator.isRequire('#m_phoneNumber', 'Vui lòng nhập số điện thoại'),
        Validator.isEmail('#m_email'),
        Validator.isRequire('#m_cmnd', 'Vui lòng nhập chứng minh nhân dân'),
        Validator.isNumber('#m_cmnd'),
        Validator.isNumber('#m_phoneNumber'),
      ],
      onSubmit: function() {
          var flat = false;
          $('#employeeTable tbody tr').each(function() {
              // Encode column and content information.
                if ($(this).find("#email").text() == $('#m_email').val()){
                  alert("Email đã tồn tại!!! Vui lòng kiểm tra lại!!!")
                  flat =true;
                  return;
                }
                if ($(this).find("#phoneNumber").text() == $('#m_phoneNumber').val()){
                  alert("Số điện thoại đã tồn tại!!! Vui lòng kiểm tra lại!!!")
                  flat =true;
                  return;
                }
                if ($(this).find("#CMND").text() == $('#m_cmnd').val()){
                  alert("CMND đã tồn tại!!! Vui lòng kiểm tra lại!!!")
                  flat =true;
                  return;
                }
                
              }
          );
          if (flat) return;
          formEdit.action = 'employeeList/' + employeeID + '/edit?_method=PUT' 
          $('#m_tagID').val($('.mOps:selected').attr('tagID'));
          formEdit.submit()
        }
      })

      var tdActive;
      var btnAcceptAdd = $('#btn-add')
      var btnDelete = $('#btn-delete')
      var btnAcceptEdit = $('#btn-accept-edit')
      var formAdd =  document.forms['form-add']
      var formEdit = document.forms['form-edit']
      var formDelete = document.forms['form-delete']
      var formAddEmployee = document.forms['form-add']

      btnDelete.click(function() {
        formDelete.action = 'employeeList/'+  employeeID + '/delete?_method=DELETE'
        formDelete.submit();
      })
    });

      
    </script>